# Домашнее задание к занятию «Компоненты Kubernetes»

## Выполнил студент группы DevOps-25 Шаповалов Кирилл

<br />

Цель занятия
------------

    Рассчитать требования к кластеру под проект

<br />

Задание. Необходимо определить требуемые ресурсы
--------

Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения.
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий.
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.

<br />

Решение
-------

Скорее всего, деплой приложения будет осуществляться через CI/CD с использованием системы контроля версий Git. Вынесем данную систему за скобки и не будем учитывать ее при расчете, поскольку на практике Git и CI/CD обычно не размещаются в кластере K8s. Здесь же хранятся Helm-чарты, создаваемые в процессе сборки приложения в CI/CD.

Однако, нужно учесть систему мониторинга, вот она будет 100% внутри кластера, а это еще +/- около 20 разных подов (Prometheus, Alertmanager, Cadvisor, разные экспортеры и т.д.), Grafana так же стоит отдельно, поскольку в нее могут поступать данные не только с одного кластера K8s.

Также, нужно учитывать служебные утилиты, необходимые как для работы приложения, так и всего кластера (CNI, StorageClass, Ingress), а это еще будет около 10 подов, в зависимости от размера кластера.

Итого, определимся с итоговым типом кластера:

3 реплики БД + 3 реплики Кеш + 5 реплик Фронт + 10 реплик Бек = 21 под, добавляем систему мониторинга и сервисы, итого ~ 60 подов.

В данном случае у нас явно небольшой кластер, который будет содержать всего до 100 подов на всех узлах суммарно.

Определимся с количеством ControlPlane нод: оптимальным количеством в данном случае будет 3 ноды, для небольшого кластера нет особого смысла делать больше. 

Предположим, что кластер будет поднят локальный, внутри периметра компании, с использованием ОС `CentOS 9 Stream`. Данная система сама по себе требует как минимум 1,5Гб ОЗУ и 2 ядра ЦПУ. Будем отталкиваться от этого.

**Расчет:**

DB: 4GB Ram 1 core vCPU x 3 = 12 GB, 3 core

Cache: 4GB Ram 1 core vCPU x 3 = 12 GB, 3 core

Frontend: 50 Mb Ram 0.2 core vCPU x 5 = 0.25 GB, 1 core

Backend: 600 Mb Ram 1 core vCPU x 10 = 6 GB, 10 core

Итого на приложение: 30.25 GB, 17 core vCPU

Так же помним, что ОС каждой ноды требует: 1.5 GB, 2 core vCPU

Добавляем на kubelet и вспомогательные сервисы: 2 GB, 1 core vCPU

Для ControlPlane нод выбираем итоговую конфигурацию 4 core vCPU и 4 GB RAM.

С данной нагрузкой вполне справятся 3 Worker ноды с конфигурацией 8 vCPU и 32 GB Ram.

Добавляем сюда резерв в виде еще одной Worker ноды на случай выхода из строя какой-либо ноды, на случай обновления приложений, даже хватит на расширение приложения.

Итоговая таблица ресурсов кластера будет выглядеть так:

| Node                   | Resources              |
|------------------------|------------------------|
| ControlPlane           | 4 core vCPU, 4 GB RAM  |
| ControlPlane           | 4 core vCPU, 4 GB RAM  |
| ControlPlane           | 4 core vCPU, 4 GB RAM  |
| Worker                 | 8 core vCPU, 32 GB RAM |
| Worker                 | 8 core vCPU, 32 GB RAM |
| Worker                 | 8 core vCPU, 32 GB RAM |
| Worker                 | 8 core vCPU, 32 GB RAM |
